<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D 2024 Generator</title>
    <style>
        :root { --bg-color: #2c3e50; --card-bg: #fdf6e3; --accent: #c0392b; --text: #2c3e50; --foundry-orange: #ff6400; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); display: flex; justify-content: center; padding: 20px; color: var(--text); }
        .container { display: grid; grid-template-columns: 300px 1fr; gap: 20px; width: 100%; max-width: 1100px; }
        .controls { background: white; padding: 20px; border-radius: 8px; height: fit-content; }
        h1 { margin-top: 0; color: var(--accent); font-size: 1.5rem; }
        label { display: block; margin-top: 15px; font-weight: bold; }
        select, textarea, input { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { background-color: var(--accent); color: white; border: none; padding: 12px; width: 100%; margin-top: 20px; cursor: pointer; border-radius: 4px; }
        button:hover { background-color: #a93226; }
        button:disabled { background-color: #95a5a6; }
        .btn-foundry { background-color: var(--foundry-orange); display: none; margin-top: 10px; }
        .btn-foundry:hover { background-color: #e65100; }
        .result-card { background-color: var(--card-bg); padding: 30px; border-radius: 4px; min-height: 400px; border: 1px solid #d4c5a3; }
        .sheet-header { border-bottom: 2px solid var(--accent); padding-bottom: 10px; margin-bottom: 20px; }
        .sheet-title { font-size: 2rem; font-weight: bold; color: var(--accent); margin: 0; }
        .sheet-subtitle { font-style: italic; color: #555; }
        .tag { display: inline-block; background: #e0e0e0; padding: 2px 8px; border-radius: 12px; font-size: 0.85rem; margin-right: 5px; }
        .mastery-tag { background: #fadbd8; color: #922b21; border: 1px solid #922b21; }
        .damage-tag { background: #d5dbdb; color: #2c3e50; font-weight: bold; border: 1px solid #7f8c8d; }
    </style>
</head>
<body>

<div class="container">
    <div class="controls">
        <h1>üõ†Ô∏è DM Tools 2024</h1>
        <label>¬øQu√© necesitas?</label>
        <select id="genType" onchange="toggleInputs()">
            <option value="character">Personaje Jugador</option>
            <option value="npc">NPC</option>
            <option value="item">Objeto / Arma</option>
        </select>
        <label>Descripci√≥n</label>
        <textarea id="description" rows="4" placeholder="Ej: Una espada larga que brilla con luz de luna..."></textarea>
        <div id="levelInput"><label>Nivel</label><input type="number" id="level" value="1" min="1" max="20"></div>
        <button id="btnGenerate" onclick="generateContent()">‚ú® Generar</button>
        <button id="btnExport" class="btn-foundry" onclick="exportToFoundry()">üé≤ Exportar a Foundry VTT</button>
    </div>

    <div class="result-card">
        <div id="loader" style="display:none; text-align:center; margin-top:100px;">üîÆ Consultando los planos arcanos...</div>
        <div id="content"><h2 style="text-align:center; color:#888; margin-top:150px;">El pergamino est√° vac√≠o.</h2></div>
    </div>
</div>

<script>
    const API_URL = "http://localhost:5001/api";
    let currentData = null;

    function toggleInputs() {
        document.getElementById('levelInput').style.display = (document.getElementById('genType').value === 'character') ? 'block' : 'none';
    }

    async function generateContent() {
        const type = document.getElementById('genType').value;
        const desc = document.getElementById('description').value;
        const level = document.getElementById('level').value;
        const btn = document.getElementById('btnGenerate');
        const loader = document.getElementById('loader');
        const content = document.getElementById('content');

        content.innerHTML = ''; loader.style.display = 'block'; btn.disabled = true;
        document.getElementById('btnExport').style.display = 'none';

        let payload = { description: desc };
        let endpoint = (type === 'character') ? '/characters/generate' : (type === 'npc') ? '/npcs/generate' : '/items/generate';
        if (type === 'character') payload.level = parseInt(level);
        if (type === 'item') payload.type = "Cualquiera";

        try {
            const response = await fetch(API_URL + endpoint, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            });
            const data = await response.json();
            if (response.ok) {
                currentData = { ...data, genType: type };
                renderResult(type, data);
                document.getElementById('btnExport').style.display = 'block';
            } else {
                content.innerHTML = `<p style="color:red">Error: ${data.error || JSON.stringify(data)}</p>`;
            }
        } catch (error) { content.innerHTML = `<p style="color:red">Error: ${error.message}</p>`; }
        finally { loader.style.display = 'none'; btn.disabled = false; btn.innerText = "‚ú® Generar"; }
    }

    function renderResult(type, data) {
        const safe = (val) => val || '---';
        let html = '';

        if (type === 'item') {
            html = `
                <div class="sheet-header">
                    <h1 class="sheet-title">${safe(data.nombre)}</h1>
                    <div class="sheet-subtitle">${safe(data.rareza)} - ${safe(data.tipo)}</div>
                </div>
                ${data.weapon_mastery ? `<span class="tag mastery-tag">‚öîÔ∏è Mastery: ${data.weapon_mastery}</span>` : ''}
                ${data.dano ? `<span class="tag damage-tag">üí• ${data.dano.formula} ${data.dano.tipo}</span>` : ''}

                <h3 class="section-title" style="margin-top:20px;">Mec√°nica</h3>
                <p>${safe(data.efecto_mecanico)}</p>
                <h3 class="section-title">Descripci√≥n</h3>
                <p style="font-style:italic;">${safe(data.descripcion_vis)}</p>
            `;
        } else if (type === 'npc') {
            html = `
                <div class="sheet-header"><h1 class="sheet-title">${safe(data.nombre)}</h1><div class="sheet-subtitle">${safe(data.raza)} - ${safe(data.rol)}</div></div>
                <p><strong>Ideal:</strong> ${safe(data.personalidad?.ideal)}</p>
                <p><strong>Gancho:</strong> ${safe(data.gancho_trama)}</p>
            `;
        } else {
            html = `
                <div class="sheet-header"><h1 class="sheet-title">${safe(data.nombre)}</h1><div class="sheet-subtitle">Nivel ${data.nivel} ${data.clase}</div></div>
                <p>${safe(data.resumen_historia)}</p>
            `;
        }
        document.getElementById('content').innerHTML = html;
    }

    function exportToFoundry() {
        if (!currentData) return;
        let foundryJSON = { "name": currentData.nombre, "img": "icons/svg/item-bag.svg", "system": {} };

        if (currentData.genType === 'item') {
            const isWeapon = currentData.tipo.toLowerCase().includes('arma') || currentData.dano;
            foundryJSON.type = isWeapon ? "weapon" : "equipment";
            foundryJSON.img = isWeapon ? "icons/svg/sword.svg" : "icons/svg/item-bag.svg";

            foundryJSON.system = {
                "description": {
                    "value": `<p>${currentData.descripcion_vis}</p><hr><p>${currentData.efecto_mecanico}</p>`
                },
                "rarity": currentData.rareza.toLowerCase().split(' ')[0] || "common",
                "equipped": true,
                "identified": true
            };

            // L√≥gica cr√≠tica para el DA√ëO en Foundry
            if (isWeapon && currentData.dano) {
                foundryJSON.system.actionType = "mwak"; // Asumimos Melee Weapon Attack por defecto
                foundryJSON.system.damage = {
                    "parts": [
                        [currentData.dano.formula + " + @mod", currentData.dano.tipo] // Estructura: ["1d8 + @mod", "slashing"]
                    ],
                    "versatile": ""
                };
                foundryJSON.system.ability = ""; // Usa la default (Fuerza/Destreza)
            }

            // A√±adir info de Mastery a la descripci√≥n
            if(currentData.weapon_mastery) {
                foundryJSON.system.description.value = `<p><strong>Mastery (${currentData.weapon_mastery}):</strong> Esta arma se beneficia de reglas de maestr√≠a.</p>` + foundryJSON.system.description.value;
            }

        } else if (currentData.genType === 'npc') {
            foundryJSON.type = "npc";
            foundryJSON.img = "icons/svg/mystery-man.svg";
            foundryJSON.system = { "details": { "biography": { "value": currentData.gancho_trama }, "race": currentData.raza } };
        } else {
            foundryJSON.type = "character";
            foundryJSON.img = "icons/svg/mystery-man.svg";
            foundryJSON.system = { "details": { "biography": { "value": currentData.resumen_historia }, "race": currentData.especie } };
        }

        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(foundryJSON, null, 2));
        const a = document.createElement('a');
        a.href = dataStr;
        a.download = `${currentData.nombre.replace(/\s+/g, '_')}_Foundry.json`;
        document.body.appendChild(a); a.click(); a.remove();
    }
</script>
</body>
</html>